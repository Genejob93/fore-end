[TOC]

# 1. 跨域问题

## 1.1 同源策略

1. **什么是同源策略**

> 同源策略(Same-Origin Policy)最早由 Netscape 公司提出，是浏览器的一种安全策略。
>
> 同源： 协议、域名、端口号 必须完全相同。
>
> 违背同源策略就是跨域。

2. **为什么会有跨域这个问题?** 

> 原因是浏览器为了安全，而采用的同源策略（Same origin policy）

**备注**：规则举例如下(假设已有网站地址为：http://study.cn)
![Alt text](https://s2.ax1x.com/2019/01/26/knAIit.png)

## 1.2 没有同源策略的危险场景

**危险场景:**

> 有一天你刚睡醒，收到一封邮件，说是你的银行账号有风险，赶紧点进www.yinghang.com改密码。你着急的赶紧点进去，还是熟悉的银行登录界面，你果断输入你的账号密码，登录进去看看钱有没有少了，睡眼朦胧的你没看清楚，平时访问的银行网站是www.yinhang.com，而现在访问的是www.yinghang.com，随后你来了一条短信，钱没了，这个钓鱼网站做了什么呢？大概是如下思路：

```js
<iframe id="baidu" src="https://www.baidu.com"></iframe>

<script type="text/javascript">
  const iframe = window.frames['baidu']
  const inputNode = iframe.document.getElementById('输入敏感信息的input的id')
  console.log(inputNode.value)
</script>
```

## 1.3 非同源收到哪些限制

```js
1. Cookie不能读取；
2. DOM无法获得；
3. Ajax请求不能发送
```

## 1.4 如何在开发中解决跨域问题

### 1.4.1 JSOP 方式解决跨域问题

> 1. **JSONP 是什么?**
>
>    > JSONP(JSON with Padding)，是一个非官方的跨域解决方案，纯粹凭借程序员的聪明才智开发出来，只支持get请求。
>
> 2.  **JSOP 怎么工作的?**
>
>    > 在网页有一些标签天生具有跨域能力，比如：img link iframe script。
>    >
>    > JSONP就是利用script标签的跨域能力来发送请求的。
>
> 3. **JSOP的使用**
>
>    > 1. 动态的创建一个 script 标签
>    >
>    >    `var script = document.createElement("script");`
>    >
>    > 2. 设置 script的src 属性, 设置回调函数
>    >
>    >    ```js
>    >    script.src = "http://localhost:3000/testAJAX?callback=abc";
>    >    function abc(data) {
>    >    	alert(data.name);
>    >    };
>    >    
>    >    ```
>    >
>    > 3. 将 script 添加到 body中
>    >
>    >    `document.body.appendChild(script);`
>    >
>    > 4. 服务器中的路由处理
>    >
>    >    ```js
>    >    router.get("/testAJAX" , function (req , res) {
>    >    	console.log("收到请求");
>    >    	var callback = req.query.callback;
>    >    	var obj = {
>    >    			name:"孙悟空",
>    >    		age:18
>    >    	}
>    >    	res.send(callback+"("+JSON.stringify(obj)+")");
>    >    });
>    >    
>    >    ```
>
> 4. jQuery 中 的 JSOP
>
>    ```js
>    <!DOCTYPE html>
>    <html lang="en">
>    <head>
>      <meta charset="UTF-8">
>      <title>Title</title>
>    </head>
>    <body>
>      <button id="btn">按钮</button>
>      <ul id="list"></ul>
>      <script type="text/javascript" src="./jquery-1.12.3.js"></script>
>      <script type="text/javascript">
>        window.onload = function () {
>          var btn = document.getElementById('btn')
>          btn.onclick = function () {
>            $.getJSON("http://api.douban.com/v2/movie/in_theaters?callback=?",function (data) {
>              console.log(data);
>              //获取所有的电影的条目
>              var subjects = data.subjects;
>              //遍历电影条目
>              for(var i=0 ; i<subjects.length ; i++){
>                $("#list").append("<li>"+
>                  subjects[i].title+"<br />"+
>                  "<img src=\""+subjects[i].images.large+"\" >"+
>                  "</li>");
>              }
>            });
>          }
>        }
>      </script>
>    </body>
>    </html>
>    
>    ```

1. **JSOP解决发送请求跨域问题**

   > 要明确的是：JSONP(JSON with Padding)不是一种技术，而是程序员“智慧的结晶”（利用了标签请求资源不受同源策略限制的特点）
   > JSONP需要前后端人员互相配合。

2. **前端页面写法** 

   ```js
   	<body>
   	  <button id="btn">按钮</button>
   	  <script type="text/javascript">
   	    var btn = document.getElementById('btn');
   	    btn.onclick = function () {
   	      //1. 创建一个script标签
   	      var script = document.createElement('script');
   	      //2. 设置回调函数
   	      window.getData = function (data) {
   	        console.log(data);//拿到数据
   	      }
   	      //3. 设置script标签src属性，填写跨域请求的地址
   	      script.src = 'http://localhost:3000/jsonp?callback=getData';
   	      //4. 将script标签添加到body中生效
   	      document.body.appendChild(script);
   	      //5.不影响整体DOM结构，删除script标签
   	      document.body.removeChild(script);
   	    }
   	  </script>
   	</body>
   ```

3. **后端写法** 

   ```js
   app.get('/jsonp', (req, res) => {
     //解构赋值获取请求参数
     const {callback} = req.query
     //去数据库查找对应数据
     const data = [{name: 'tom', age: 18}, {name: 'jerry', age: 20}];
     res.send(callback + '(' + JSON.stringify(data) + ')');
   })
   ```

### 1.4.2 CORS 方式解决跨域

1. **CORS 是什么?**

   > CORS（Cross-Origin Resource
   > Sharing），跨域资源共享。CORS是官方的跨域解决方案，它的特点是不需要在客户端做任何特殊的操作，完全在服务器中进行处理，支持get和post请求。

2. **CORS 是怎么工作的?**

   > CORS是通过设置一个响应头来告诉浏览器，该请求允许跨域，浏览器收到该响应以后就会对响应放行。

3. CORS 的使用

   ```js
   主要是服务器端的设置：
   router.get("/testAJAX" , function (req , res) {
     
   	//通过res来设置响应头，来允许跨域请求
   	//res.set("Access-Control-Allow-Origin","http://127.0.0.1:3000");  
     
   	res.set("Access-Control-Allow-Origin","*");
     
   	res.send("testAJAX返回的响应");
   });
   
   ```

### 1.4.3 使用Nginx 代理服务器解决跨域

```js
例如: nginx等
```

















































































































































































